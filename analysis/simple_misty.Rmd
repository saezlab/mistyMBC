---
title: "simple_misty"
author: "Jovan Tanevski"
date: "2021-06-09"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

# Setup

```{r setup, message=FALSE}
library(reticulate)
library(mistyR)
library(future)
library(purrr)
library(stringr)

use_python("/usr/local/bin/python3")
```


# Extract counts and geometry

Requires `python3` and anndata installed (`pip install anndata`).

```{python}
import anndata

def read_and_extract(datapath):
  adata = anndata.read(datapath)
  counts = adata.obsm["counts"]
  geom = adata.obs[["x_orig", "y_orig"]]
  markers = adata.uns["counts_var"]
  return counts, geom, markers

```

# Run misty 

Define standard view composition and run MISTy on all h5ad files that don't contain scRNAseq in their filename.


```{r run_misty}
plan(multisession)

list.files("data", ".h5ad", recursive = TRUE, full.names = TRUE) %>%
  keep(~ str_detect(.x, "scRNAseq", negate = TRUE)) %>%
  walk(function(datapath) {
    data <- py$read_and_extract(datapath)
    expr <- as.data.frame(as.matrix(data[[1]]))
    colnames(expr) <- make.names(data[[3]])
    pos <- data[[2]]

    unique(str_extract(rownames(pos), "-\\d$")) %>% walk(function(replicate) {
      ind <- str_which(rownames(pos), paste0(replicate, "$"))
      misty.views <- create_initial_view(expr[ind, ]) %>%
        add_juxtaview(pos[ind, ]) %>%
        add_paraview(pos[ind, ], 100)

      run_misty(misty.views,
        results.folder = paste0(
          str_replace(
            str_remove(datapath, ".h5ad"),
            "data", "output"
          ),
          replicate
        )
      )
    })
  })
```
